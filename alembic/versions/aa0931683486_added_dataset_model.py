# coding=utf-8
"""Added Dataset Model

Revision ID: aa0931683486
Revises:
Create Date: 2016-12-07 15:06:31.093099

"""
from alembic import op
import sqlalchemy as sa
import sys
import os
dirname = os.path.dirname
abspath = os.path.abspath
app_path = abspath(dirname(dirname(dirname(__file__))))
sys.path.insert(0, app_path)
# revision identifiers, used by Alembic.
from apps.core.models.fields import AwareDateTime
from apps.core.models.fields import NoConstraintEnum

revision = 'aa0931683486'
down_revision = None
branch_labels = None
depends_on = None


def upgrade():
    ### commands auto generated by Alembic - please adjust! ###
    dataset_table = op.create_table('datasetmodels_tbl',
                                    sa.Column('id', sa.Integer(),
                                              nullable=False),
                                    sa.Column('user_id', sa.Integer(),
                                              nullable=True),
                                    sa.Column('name', sa.VARCHAR(
                                        length=20), nullable=True),
                                    sa.Column('description',
                                              sa.Text(), nullable=True),
                                    sa.Column('type', NoConstraintEnum(
                                        u'csv', u'picture', native_enum=False), nullable=True),
                                    sa.Column('target_column',
                                              sa.Integer(), nullable=True),
                                    sa.Column('data', sa.BLOB(),
                                              nullable=True),
                                    sa.PrimaryKeyConstraint('id'),
                                    mysql_charset=u'utf8',
                                    mysql_engine=u'InnoDB'
                                    )
    dataset_list = []
    CATOGORY2FILENAME = [
        ("iris0", "data/iris0.csv"),
        ("iris1", "data/iris1.csv"),
    ]
    for name, filepath in CATOGORY2FILENAME:
        with open(filepath) as fin:
            content = fin.read()
        dataset_list.append({
            "name": name,
            "type": "csv",
            "target_column": -1,
            "data": content,
            "description": "鸢尾花花瓣数据样本https://en.wikipedia.org/wiki/Iris_flower_data_set",
        })
    with open("data/housing.csv") as fin:
        content = fin.read()
        dataset_list.append({
            "name": "boston_price",
            "type": "csv",
            "target_column": -1,
            "data": content,
            "description": "波士顿房价数据样本http://archive.ics.uci.edu/ml/datasets/Housing",
        })
    op.bulk_insert(dataset_table, dataset_list)
    op.create_table('users_tbl',
                    sa.Column('created_at', AwareDateTime(), nullable=False),
                    sa.Column('updated_at', AwareDateTime(), nullable=False),
                    sa.Column('deleted_at', AwareDateTime(), nullable=True),
                    sa.Column('id', sa.Integer(), nullable=False),
                    sa.Column('username', sa.VARCHAR(
                        length=200), nullable=False),
                    sa.Column('tenant_id', sa.VARCHAR(
                        length=50), nullable=False),
                    sa.Column('user_id', sa.VARCHAR(
                        length=50), nullable=False),
                    sa.PrimaryKeyConstraint('id'),
                    mysql_charset=u'utf8',
                    mysql_engine=u'InnoDB'
                    )
    op.create_index('idx_tenant_id_user_id', 'users_tbl', [
                    'tenant_id', 'user_id'], unique=False)
    op.create_index(op.f('ix_users_tbl_created_at'),
                    'users_tbl', ['created_at'], unique=False)
    ### end Alembic commands ###


def downgrade():
    ### commands auto generated by Alembic - please adjust! ###
    op.drop_index(op.f('ix_users_tbl_created_at'), table_name='users_tbl')
    op.drop_index('idx_tenant_id_user_id', table_name='users_tbl')
    op.drop_table('users_tbl')
    op.drop_table('datasetmodels_tbl')
    ### end Alembic commands ###
